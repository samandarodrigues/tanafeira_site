<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Criar conta - Comprador</title>
  <style>
    body{font-family:system-ui;max-width:760px;margin:24px auto;padding:0 16px}
    .card{border:1px solid #ddd;border-radius:16px;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:14px;opacity:.85;margin-bottom:6px}
    input,button,select{width:100%;padding:12px;border:1px solid #ccc;border-radius:12px;font-size:16px}
    input:focus,select:focus{outline:2px solid #1112}
    button{cursor:pointer;border:0}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn{background:#111;color:#fff}
    .btn2{background:#f2f2f2}
    .muted{opacity:.75;font-size:13px}
    #msg{display:none;margin-top:12px;padding:10px;border-radius:12px}
    .span2{grid-column:1/-1}

    /* ===== senha com botão alinhado (sem emoji) ===== */
    .pwfield{display:flex;flex-direction:column;gap:6px}
    .pwrow{position:relative}
    .pwrow input{padding-right:110px;}
    .pwbtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:auto;
      min-width:92px;
      height:42px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#2b2b2b;
      font-weight:800;
      font-size:13px;
    }

    @media (max-width:640px){
      .grid{grid-template-columns:1fr}
      .pwbtn{display:none;}
      .pwrow input{padding-right:12px;}
    }
    input::-ms-reveal, input::-ms-clear{display:none;}
  </style>
</head>
<body>
  <h1>Criar conta (Comprador)</h1>

  <div class="card">
    <form id="form" class="grid" novalidate>
      <div>
        <label for="first_name">Nome</label>
        <input id="first_name" name="first_name" required autocomplete="given-name" maxlength="30" />
        <div class="muted">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="last_name">Sobrenome</label>
        <input id="last_name" name="last_name" required autocomplete="family-name" maxlength="30" />
        <div class="muted">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="phone">Celular</label>
        <input id="phone" name="phone" required inputmode="tel" autocomplete="tel-national"
               placeholder="(89) 91234-5678" />
      </div>

      <div>
        <label for="email">Email</label>
        <input
          id="email"
          name="email"
          required
          type="email"
          autocomplete="email"
          placeholder="voce@email.com"
          maxlength="254"
        />
      </div>

      <div>
        <label for="cep">CEP</label>
        <input id="cep" name="postal_code" required inputmode="numeric" autocomplete="postal-code"
               placeholder="00000-000" maxlength="9" />
        <div class="muted">Aceito apenas Vale do Itaim (PI/PE).</div>
      </div>

      <div>
        <label for="numero">Número</label>
        <input id="numero" name="street_number" required placeholder="Ex: 123" autocomplete="address-line2" />
      </div>

      <div class="span2">
        <label for="rua">Rua</label>
        <input id="rua" name="address_line1" required autocomplete="address-line1" placeholder="Preenchido pelo CEP" />
      </div>

      <div>
        <label for="bairro">Bairro</label>
        <input id="bairro" name="neighborhood" required autocomplete="address-level3" placeholder="Preenchido pelo CEP" />
      </div>

      <div>
        <label for="cidade">Cidade</label>
        <input id="cidade" name="address_level2" required autocomplete="address-level2" placeholder="Preenchido pelo CEP" />
      </div>

      <div>
        <label for="uf">UF (somente PI/PE)</label>
        <select id="uf" name="address_level1" autocomplete="address-level1" required>
          <option value="">Selecione...</option>
          <option value="PI">PI</option>
          <option value="PE">PE</option>
        </select>
      </div>

      <div>
        <label for="complemento">Complemento (opcional)</label>
        <input id="complemento" name="address_line2" autocomplete="address-line2"
               placeholder="Apto, bloco, referência..." />
      </div>

      <div class="span2 pwfield">
        <label for="password">Senha</label>
        <div class="pwrow">
          <input id="password" name="password" type="password" minlength="6" required autocomplete="new-password" />
          <button class="pwbtn" type="button" data-toggle="password" aria-label="Mostrar senha">Mostrar</button>
        </div>
      </div>

      <div class="span2 pwfield">
        <label for="password2">Confirmar senha</label>
        <div class="pwrow">
          <input id="password2" name="password2" type="password" minlength="6" required autocomplete="new-password" />
          <button class="pwbtn" type="button" data-toggle="password2" aria-label="Mostrar confirmação">Mostrar</button>
        </div>
      </div>

      <button id="submitBtn" class="btn span2" type="submit">Criar conta</button>
      <button class="btn2 span2" type="button" id="back">Voltar</button>
    </form>

    <div id="msg"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://addedjckqdzwgdstgqfz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WaH0GklqXIWCYjL2jVzZjg_GD6XdrXB";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const UF_ALLOWED = new Set(["PI","PE"]);

    const qs = (id)=>document.getElementById(id);
    const msgEl = qs("msg");
    const submitBtn = qs("submitBtn");

    function showMsg(text, isErr=false){
      msgEl.style.display="block";
      msgEl.style.background = isErr ? "#ffe9e9" : "#e9ffe9";
      msgEl.style.border = "1px solid " + (isErr ? "#f0b7b7" : "#b7f0b7");
      msgEl.textContent = text;
    }
    function clearMsg(){
      msgEl.style.display="none";
      msgEl.textContent = "";
    }

    function onlyDigits(s){ return (s||"").replace(/\D/g,""); }

    // email forte
    function isValidEmail(email){
      const e = (email || "").trim();
      if (!e) return false;
      if (e.includes(" ")) return false;
      if ((e.match(/@/g) || []).length !== 1) return false;
      if (e.includes("..")) return false;
      if (e.startsWith(".") || e.endsWith(".")) return false;

      const [local, domain] = e.split("@");
      if (!local || !domain) return false;
      if (local.length > 64) return false;
      if (e.length > 254) return false;

      if (!/^[A-Za-z0-9.!#$%&'*+/=?^_`{|}~-]+$/.test(local)) return false;

      if (!domain.includes(".")) return false;
      const parts = domain.split(".");
      if (parts.some(p => !p || p.length > 63)) return false;
      if (parts.some(p => p.startsWith("-") || p.endsWith("-"))) return false;
      if (parts.some(p => !/^[A-Za-z0-9-]+$/.test(p))) return false;

      const tld = parts[parts.length - 1];
      if (!/^[A-Za-z]{2,}$/.test(tld)) return false;

      return true;
    }

    // trava extra de 30 chars
    function clampLen(id, max){
      const el = qs(id);
      if (!el) return;
      el.addEventListener("input", ()=>{
        if (el.value.length > max) el.value = el.value.slice(0, max);
      });
    }
    clampLen("first_name", 30);
    clampLen("last_name", 30);

    // máscaras
    function maskPhone(v){
      const d = onlyDigits(v).slice(0,11);
      if (d.length <= 2) return d ? `(${d}` : "";
      if (d.length <= 6) return `(${d.slice(0,2)}) ${d.slice(2)}`;
      if (d.length === 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6,10)}`;
      return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7,11)}`;
    }
    function maskCEP(v){
      const d = onlyDigits(v).slice(0,8);
      if (d.length <= 5) return d;
      return `${d.slice(0,5)}-${d.slice(5,8)}`;
    }
    qs("phone").addEventListener("input", e=> e.target.value = maskPhone(e.target.value));
    qs("cep").addEventListener("input", e=> e.target.value = maskCEP(e.target.value));

    // mostrar/ocultar (desktop)
    document.querySelectorAll("button[data-toggle]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-toggle");
        const input = document.getElementById(id);
        if (!input) return;
        const isPw = input.type === "password";
        input.type = isPw ? "text" : "password";
        btn.textContent = isPw ? "Ocultar" : "Mostrar";
      });
    });

    // ViaCEP + UF limitada
    async function fetchCEP(cep){
      const c = onlyDigits(cep);
      if (c.length !== 8) return null;
      const res = await fetch(`https://viacep.com.br/ws/${c}/json/`);
      const data = await res.json();
      if (data.erro) return null;
      return data;
    }

    async function fillAddressByCEP(){
      const data = await fetchCEP(qs("cep").value);
      if (!data) return;

      const uf = (data.uf || "").toUpperCase();
      if (!UF_ALLOWED.has(uf)) {
        showMsg("CEP fora da área atendida (somente PI/PE – Vale do Itaim).", true);
        qs("rua").value = ""; qs("bairro").value = ""; qs("cidade").value = "";
        qs("uf").value = "";
        return;
      }

      qs("rua").value = data.logradouro || "";
      qs("bairro").value = data.bairro || "";
      qs("cidade").value = data.localidade || "";
      qs("uf").value = uf;
    }

    qs("cep").addEventListener("blur", async ()=>{
      try { await fillAddressByCEP(); }
      catch(e){ showMsg("Não consegui buscar o CEP.", true); }
    });

    qs("form").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      clearMsg();

      submitBtn.disabled = true;
      submitBtn.textContent = "Criando...";

      const first_name = qs("first_name").value.trim();
      const last_name  = qs("last_name").value.trim();
      const full_name  = (first_name + " " + last_name).trim();

      const phone = qs("phone").value.trim();
      const email = qs("email").value.trim().toLowerCase();

      if (!isValidEmail(email)) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Criar conta";
        return showMsg("Digite um e-mail válido (ex: nome@email.com).", true);
      }

      const cep = qs("cep").value.trim();
      const rua = qs("rua").value.trim();
      const numero = qs("numero").value.trim();
      const bairro = qs("bairro").value.trim();
      const cidade = qs("cidade").value.trim();
      const uf = qs("uf").value.trim().toUpperCase();
      const complemento = qs("complemento").value.trim(); // opcional

      if (!cep || !rua || !numero || !bairro || !cidade) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Criar conta";
        return showMsg("Preencha CEP, rua, número, bairro e cidade. (Somente complemento é opcional)", true);
      }

      if (!UF_ALLOWED.has(uf)) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Criar conta";
        return showMsg("UF inválida. Somente PI ou PE.", true);
      }

      const password = qs("password").value;
      const password2 = qs("password2").value;
      if (password !== password2) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Criar conta";
        return showMsg("As senhas não conferem.", true);
      }

      const address_text = [
        rua && (rua + (numero ? ", " + numero : "")),
        bairro,
        cidade && (cidade + (uf ? " - " + uf : "")),
        cep && ("CEP " + cep),
        complemento
      ].filter(Boolean).join(" • ");

      try{
        const { error } = await sb.auth.signUp({
          email,
          password,
          options: { data: {
            role: "buyer",
            first_name,
            last_name,
            full_name,
            phone,
            city: cidade || address_text,
            location_text: address_text,
            address_text
          }}
        });
        if (error) throw error;

        showMsg("Conta criada! Confirme seu e-mail e depois faça login.", false);
        setTimeout(()=> location.href = "login.html", 1200);
      }catch(e){
        showMsg(e.message || "Erro ao criar conta.", true);
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = "Criar conta";
      }
    });

    qs("back").onclick = ()=> location.href="login.html";
  </script>
</body>
</html>