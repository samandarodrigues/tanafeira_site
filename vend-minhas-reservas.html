<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vendedor - Minhas Reservas</title>

  <style>
    body{font-family:system-ui;max-width:900px;margin:24px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:10px}
    h1{margin:0}
    .btn{padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;font-weight:800}
    .btn:hover{background:#f6f6f6}
    .card{border:1px solid #ddd;border-radius:16px;padding:14px;margin-top:12px}
    .muted{opacity:.7}
    .status{font-weight:900}
    #msg{display:none;margin:12px 0;padding:10px;border-radius:12px;border:1px solid #ddd}
  </style>
</head>
<body>

<header>
  <h1>üßæ Minhas Reservas (vendedor)</h1>
  <button class="btn" id="back">Voltar</button>
</header>

<div id="msg"></div>
<div id="list"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const sb = supabase.createClient(
  "https://addedjckqdzwgdstgqfz.supabase.co",
  "sb_publishable_WaH0GklqXIWCYjL2jVzZjg_GD6XdrXB"
);

const list = document.getElementById("list");
const msgEl = document.getElementById("msg");

function showMsg(text, isErr=false){
  msgEl.style.display="block";
  msgEl.style.background = isErr ? "#ffe9e9" : "#e9ffe9";
  msgEl.style.border = "1px solid " + (isErr ? "#f0b7b7" : "#b7f0b7");
  msgEl.textContent = text;
}
function clearMsg(){ msgEl.style.display="none"; msgEl.textContent=""; }

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// pega a quantidade independente do nome real da coluna
function getQty(row){
  const keys = ["quantity","qty","qtd","amount","units","count"];
  for (const k of keys){
    if (row && row[k] != null) return row[k];
  }
  return null;
}

// traduz status para PT-BR
function statusPT(s){
  const v = String(s || "").toLowerCase().trim();
  if (!v) return "‚Äî";
  const map = {
    pending: "Pendente",
    confirmed: "Confirmada",
    canceled: "Cancelada",
    cancelled: "Cancelada",
    rejected: "Recusada",
    done: "Conclu√≠da",
    completed: "Conclu√≠da"
  };
  return map[v] || (v.charAt(0).toUpperCase() + v.slice(1));
}

async function load(){
  clearMsg();
  list.innerHTML = `<div class="muted" style="margin-top:16px">Carregando...</div>`;

  const { data:{user}, error: uerr } = await sb.auth.getUser();
  if(uerr) return showMsg(uerr.message || "Erro auth", true);
  if(!user) return location.href="login.html";

  // pega tudo para n√£o quebrar por coluna faltando
  const { data: resv, error: rerr } = await sb
    .from("reservations")
    .select("*")
    .eq("buyer_id", user.id)
    .order("created_at", { ascending:false });

  if(rerr){
    return showMsg(rerr.message || "Erro ao carregar reservas.", true);
  }

  if(!resv || resv.length === 0){
    list.innerHTML = `<div class="muted" style="margin-top:16px">Voc√™ ainda n√£o fez reservas.</div>`;
    return;
  }

  // tenta descobrir qual campo √© o id do produto
  const productIdField =
    ("product_id" in resv[0]) ? "product_id" :
    ("produto_id" in resv[0]) ? "produto_id" :
    ("products_id" in resv[0]) ? "products_id" :
    null;

  const productIds = productIdField
    ? Array.from(new Set(resv.map(r => r[productIdField]).filter(Boolean)))
    : [];

  let productsMap = new Map();

  if(productIds.length){
    // ‚úÖ tenta pegar name OU title (qual existir)
    const { data: prods, error: perr } = await sb
      .from("products")
      .select("id,name,title,unit")
      .in("id", productIds);

    if(perr){
      // Se RLS bloquear, ok: s√≥ mostra "Produto indispon√≠vel"
      showMsg("Aviso: n√£o consegui carregar nome dos produtos (RLS).", true);
    }else{
      (prods||[]).forEach(p => productsMap.set(String(p.id), p));
    }
  }

  list.innerHTML = resv.map(r=>{
    const pid = productIdField ? r[productIdField] : null;
    const p = pid ? productsMap.get(String(pid)) : null;

    const prodName = (p?.name || p?.title || "").trim();
    const title = prodName || "Produto indispon√≠vel";
    const unit = p?.unit ? (" ‚Ä¢ " + p.unit) : "";

    const qty = getQty(r);
    const qtyText = (qty != null) ? qty : "‚Äî";

    return `
      <div class="card">
        <strong>${escapeHtml(title)}</strong>
        <div class="muted">Quantidade: ${escapeHtml(String(qtyText))}${escapeHtml(unit)}</div>
        <div class="status">Status: ${escapeHtml(statusPT(r.status))}</div>
        <div class="muted" style="font-size:12px;margin-top:6px">
          ${r.created_at ? new Date(r.created_at).toLocaleString("pt-BR") : ""}
        </div>
      </div>
    `;
  }).join("");
}

document.getElementById("back").onclick = ()=> location.href="vend-home.html";
load();
</script>
</body>
</html>
