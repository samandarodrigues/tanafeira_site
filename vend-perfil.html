<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vendedor - Perfil</title>

  <style>
    body{font-family:system-ui;max-width:980px;margin:24px auto;padding:0 16px}
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 0;border-bottom:1px solid #eee;margin-bottom:14px;
    }
    .brand{font-weight:900;font-size:18px}
    .muted{opacity:.75}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;
      font-weight:800;
    }
    .btn:hover{background:#f6f6f6}
    .btn-primary{background:#111;color:#fff;border:0}
    .btn-primary:hover{filter:brightness(.95)}
    button:disabled{opacity:.6;cursor:not-allowed}

    #msg{display:none;margin:12px 0;padding:10px;border-radius:12px;border:1px solid #ddd}

    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .span2{grid-column:1/-1}
    label{display:block;font-size:14px;opacity:.85;margin:6px 0}
    input,textarea{
      width:100%;padding:12px;border:1px solid #ccc;border-radius:12px;font-size:16px;
    }
    input:focus,textarea:focus{outline:2px solid #1112}
    textarea{min-height:110px;resize:vertical}

    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;
      user-select:none;
    }
    .chip input{width:18px;height:18px;margin:0}
    .chip b{font-size:14px}
    .hint{font-size:13px;opacity:.75;margin-top:8px}

    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="brand">TaNaFeira</div>
      <div id="subtitle" class="muted">Meu perfil (vendedor)</div>
    </div>
    <div class="right">
      <button class="btn" id="back" type="button">Voltar</button>
      <button class="btn" id="logout" type="button">Sair</button>
    </div>
  </header>

  <div id="msg"></div>

  <div class="card">
    <h2 style="margin:0 0 10px">Dados do vendedor</h2>

    <form id="form" class="grid" novalidate>
      <div>
        <label for="first_name">Nome</label>
        <input id="first_name" maxlength="30" autocomplete="given-name" required />
        <div class="hint">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="last_name">Sobrenome</label>
        <input id="last_name" maxlength="30" autocomplete="family-name" required />
        <div class="hint">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="phone">Celular</label>
        <input id="phone" inputmode="tel" autocomplete="tel-national" placeholder="(89) 91234-5678" required />
      </div>

      <div>
        <label for="emailView">Email (login)</label>
        <input id="emailView" disabled />
        <div class="hint">Esse é o email da sua conta.</div>
      </div>

      <div>
        <label for="city">Cidade</label>
        <input id="city" autocomplete="address-level2" placeholder="Ex: Picos" />
      </div>

      <div class="span2">
        <label for="address_text">Endereço (1 linha)</label>
        <input id="address_text" placeholder="Rua, número • bairro • cidade - UF • CEP..." />
        <div class="hint">Campo em uma linha (o que você disse que sempre funcionou).</div>
      </div>

      <div class="span2">
        <label for="bio">Bio do vendedor</label>
        <textarea id="bio" placeholder="Ex: Sou produtor local, colheita no dia, entrego na feira..."></textarea>
        <div class="hint">Salvo no Auth + no profiles (duplo) pra nunca sumir.</div>
      </div>

      <div class="span2" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button id="saveBtn" class="btn btn-primary" type="submit">Salvar</button>
        <button id="refreshBtn" class="btn" type="button">Recarregar</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px">Categorias que eu vendo</h2>
    <div class="muted">Escolha as categorias que aparecem no seu perfil.</div>

    <div id="catsBox" class="chips" style="margin-top:12px">
      <span class="muted">Carregando categorias...</span>
    </div>

    <div class="hint">
      Se existir a tabela <b>vendor_categories</b>, eu salvo lá. Se não existir, salvo no Auth (user_metadata).
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button id="saveCatsBtn" class="btn btn-primary" type="button">Salvar categorias</button>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://addedjckqdzwgdstgqfz.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WaH0GklqXIWCYjL2jVzZjg_GD6XdrXB";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id)=>document.getElementById(id);
    const msgEl = el("msg");

    function showMsg(text, isErr=false){
      msgEl.style.display="block";
      msgEl.style.padding="10px";
      msgEl.style.borderRadius="12px";
      msgEl.style.border="1px solid " + (isErr ? "#f0b7b7" : "#b7f0b7");
      msgEl.style.background= isErr ? "#ffe9e9" : "#e9ffe9";
      msgEl.textContent = text;
    }
    function clearMsg(){ msgEl.style.display="none"; msgEl.textContent=""; }

    // ===== phone mask =====
    function onlyDigits(s){ return (s||"").replace(/\D/g,""); }
    function maskPhone(v){
      const d = onlyDigits(v).slice(0,11);
      if (d.length <= 2) return d ? `(${d}` : "";
      if (d.length <= 7) return `(${d.slice(0,2)}) ${d.slice(2)}`;
      return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7,11)}`;
    }
    el("phone").addEventListener("input", (e)=> e.target.value = maskPhone(e.target.value));

    // ===== minimal vendor guard (profiles só pro role) =====
    async function requireVendor(){
      const { data: { user }, error } = await sb.auth.getUser();
      if (error) throw error;
      if (!user){ location.href="login.html"; return null; }

      const { data: prof, error: e2 } = await sb
        .from("profiles")
        .select("id, role, full_name, bio")
        .eq("id", user.id)
        .maybeSingle();

      if (e2) throw e2;
      if (!prof) throw new Error("Seu perfil não foi encontrado. Faça logout/login ou recrie a conta.");
      if (prof.role !== "vendor"){ location.href="telainicial-comp.html"; return null; }

      el("subtitle").textContent = "Meu perfil (vendedor) — " + (prof.full_name || user.email || "");
      return { user, prof };
    }

    // ===== metadata helpers =====
    function metaStr(user, key, fallback=""){
      const v = user?.user_metadata?.[key];
      return (typeof v === "string") ? v : fallback;
    }

    function fillFormFromSources(user, prof){
      el("emailView").value = user?.email || "";

      el("first_name").value   = metaStr(user, "first_name", "");
      el("last_name").value    = metaStr(user, "last_name", "");
      el("phone").value        = metaStr(user, "phone", "");
      el("city").value         = metaStr(user, "city", "");
      el("address_text").value = metaStr(user, "address_text", "");

      // ✅ bio: primeiro metadata; se vazio, pega do profiles.bio
      const bioMeta = metaStr(user, "vendor_bio", "");
      el("bio").value = bioMeta || (prof?.bio || "");
    }

    async function saveProfileMeta(payload){
      const { error } = await sb.auth.updateUser({ data: payload });
      if (error) throw error;
    }

    // ===== categories =====
    let CATEGORIES = [];

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function getSelectedCategoryIds(){
      return Array.from(document.querySelectorAll('input[name="cat"]:checked'))
        .map(x => x.value);
    }

    function renderCategories(selectedIds){
      const box = el("catsBox");
      if (!CATEGORIES.length){
        box.innerHTML = `<span class="muted">Nenhuma categoria encontrada.</span>`;
        return;
      }

      const set = new Set((selectedIds || []).map(String));
      box.innerHTML = CATEGORIES.map(c => {
        const checked = set.has(String(c.id)) ? "checked" : "";
        return `
          <label class="chip" title="${escapeHtml(c.name)}">
            <input type="checkbox" name="cat" value="${c.id}" ${checked}>
            <b>${escapeHtml(c.name)}</b>
          </label>
        `;
      }).join("");
    }

    async function loadCategories(){
      const { data, error } = await sb
        .from("categories")
        .select("id,name")
        .order("name", { ascending: true });
      if (error) throw error;
      CATEGORIES = data || [];
    }

    async function loadVendorCategoryIds(user){
      try{
        const { data, error } = await sb
          .from("vendor_categories")
          .select("category_id")
          .eq("vendor_id", user.id);

        if (error) throw error;
        return (data || []).map(x => String(x.category_id));
      }catch(e){
        const meta = user.user_metadata || {};
        const ids = meta.vendor_category_ids || [];
        return (Array.isArray(ids) ? ids : []).map(String);
      }
    }

    async function saveVendorCategories(user, ids){
      try{
        const del = await sb.from("vendor_categories").delete().eq("vendor_id", user.id);
        if (del.error) throw del.error;

        if (ids.length){
          const rows = ids.map(cid => ({ vendor_id: user.id, category_id: Number(cid) }));
          const ins = await sb.from("vendor_categories").insert(rows);
          if (ins.error) throw ins.error;
        }

        showMsg("Categorias salvas ✅", false);
        return;
      }catch(e){
        const { error } = await sb.auth.updateUser({ data: { vendor_category_ids: ids } });
        if (error) return showMsg(error.message || "Erro ao salvar categorias.", true);
        showMsg("Categorias salvas ✅ (fallback)", false);
      }
    }

    // ===== reload =====
    async function reloadAll(){
      clearMsg();
      const pack = await requireVendor();
      if (!pack) return;

      const { user, prof } = pack;

      fillFormFromSources(user, prof);

      await loadCategories();
      const selected = await loadVendorCategoryIds(user);
      renderCategories(selected);
    }

    el("refreshBtn").onclick = reloadAll;

    // ===== save profile =====
    el("form").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      clearMsg();

      const saveBtn = el("saveBtn");
      saveBtn.disabled = true;
      saveBtn.textContent = "Salvando...";

      try{
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return location.href="login.html";

        const first_name = el("first_name").value.trim().slice(0,30);
        const last_name  = el("last_name").value.trim().slice(0,30);
        const full_name  = (first_name + " " + last_name).trim();

        const phone = el("phone").value.trim();
        const city  = el("city").value.trim();
        const address_text = el("address_text").value.trim();
        const bio = el("bio").value.trim();

        if (!first_name) return showMsg("Informe o nome.", true);
        if (!last_name)  return showMsg("Informe o sobrenome.", true);
        if (!phone)      return showMsg("Informe o celular.", true);

        // ✅ salva no Auth metadata (não some)
        await saveProfileMeta({
          first_name,
          last_name,
          full_name,
          phone,
          city: city || null,
          address_text: address_text || null,
          vendor_bio: bio || ""
        });

        // ✅ salva também no profiles (bio + full_name) — duplo
        try{
          const up = await sb.from("profiles")
            .update({ full_name, bio: bio || null })
            .eq("id", user.id);
          if (up.error) throw up.error;
        }catch(_e){}

        showMsg("Perfil salvo ✅", false);
        await reloadAll();

      }catch(e){
        console.error(e);
        showMsg(e.message || "Erro ao salvar perfil.", true);
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = "Salvar";
      }
    });

    // ===== save categories =====
    el("saveCatsBtn").onclick = async ()=>{
      clearMsg();
      try{
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return location.href="login.html";

        const ids = getSelectedCategoryIds();
        await saveVendorCategories(user, ids);
      }catch(e){
        console.error(e);
        showMsg(e.message || "Erro ao salvar categorias.", true);
      }
    };

    // ===== nav =====
    el("back").onclick = ()=> location.href = "vend-home.html";
    el("logout").onclick = async ()=>{
      await sb.auth.signOut();
      location.href = "login.html";
    };

    (async ()=>{
      try{ await reloadAll(); }
      catch(e){ console.error(e); showMsg(e.message || "Erro ao carregar perfil.", true); }
    })();
  </script>
</body>
</html>