<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comprador - Perfil</title>

  <style>
    body{font-family:system-ui;max-width:980px;margin:24px auto;padding:0 16px}
    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 0;border-bottom:1px solid #eee;margin-bottom:14px;
    }
    .brand{font-weight:900;font-size:18px}
    .muted{opacity:.75}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;
      font-weight:800;
    }
    .btn:hover{background:#f6f6f6}
    .btn-primary{background:#111;color:#fff;border:0}
    .btn-primary:hover{filter:brightness(.95)}
    button:disabled{opacity:.6;cursor:not-allowed}

    #msg{display:none;margin:12px 0;padding:10px;border-radius:12px;border:1px solid #ddd}

    .card{border:1px solid #ddd;border-radius:16px;padding:16px;margin-top:14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .span2{grid-column:1/-1}
    label{display:block;font-size:14px;opacity:.85;margin:6px 0}
    input{
      width:100%;padding:12px;border:1px solid #ccc;border-radius:12px;font-size:16px;
      background:#fff;
    }
    input:focus{outline:2px solid #1112}
    input[readonly]{background:#f7f7f7;color:#333}

    .hint{font-size:13px;opacity:.75;margin-top:6px}

    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="brand">TaNaFeira</div>
      <div id="subtitle" class="muted">Meu perfil (comprador)</div>
    </div>
    <div class="right">
      <button class="btn" id="back" type="button">Voltar</button>
      <button class="btn" id="logout" type="button">Sair</button>
    </div>
  </header>

  <div id="msg"></div>

  <div class="card">
    <h2 style="margin:0 0 10px">Dados do comprador</h2>

    <form id="form" class="grid" novalidate>
      <div>
        <label for="first_name">Nome</label>
        <input id="first_name" maxlength="30" autocomplete="given-name" required />
        <div class="hint">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="last_name">Sobrenome</label>
        <input id="last_name" maxlength="30" autocomplete="family-name" required />
        <div class="hint">Máx 30 caracteres.</div>
      </div>

      <div>
        <label for="phone">Celular</label>
        <input id="phone" inputmode="tel" autocomplete="tel-national" placeholder="(89) 91234-5678" required />
      </div>

      <div>
        <label for="email">Email</label>
        <input id="email" type="email" readonly />
        <div class="hint">O email é o mesmo da conta (não edita aqui).</div>
      </div>

      <div class="span2">
        <label for="address_text">Endereço (linha única)</label>
        <input id="address_text" placeholder="Rua, número • bairro • cidade - UF • CEP..." />
        <div class="hint">Ex: Rua X, 123 • Centro • Picos - PI • CEP 64600-000</div>
      </div>

      <div class="span2" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <button id="saveBtn" class="btn btn-primary" type="submit">Salvar</button>
        <button id="reloadBtn" class="btn" type="button">Recarregar</button>
      </div>
    </form>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const sb = supabase.createClient(
      "https://addedjckqdzwgdstgqfz.supabase.co",
      "sb_publishable_WaH0GklqXIWCYjL2jVzZjg_GD6XdrXB"
    );

    const el = (id)=>document.getElementById(id);
    const msgEl = el("msg");

    function showMsg(text, isErr=false){
      msgEl.style.display="block";
      msgEl.style.borderColor = isErr ? "#f0b7b7" : "#b7f0b7";
      msgEl.style.background  = isErr ? "#ffe9e9" : "#e9ffe9";
      msgEl.textContent = text;
    }
    function clearMsg(){ msgEl.style.display="none"; msgEl.textContent=""; }

    function onlyDigits(s){ return (s||"").replace(/\D/g,""); }
    function maskPhone(v){
      const d = onlyDigits(v).slice(0,11);
      if (d.length <= 2) return d ? `(${d}` : "";
      if (d.length <= 7) return `(${d.slice(0,2)}) ${d.slice(2)}`;
      return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7,11)}`;
    }
    el("phone").addEventListener("input", (e)=> e.target.value = maskPhone(e.target.value));

    function metaGet(user, key, fallback=""){
      const v = user?.user_metadata?.[key];
      return (typeof v === "string") ? v : fallback;
    }

    async function requireAuth(){
      const { data:{ user }, error } = await sb.auth.getUser();
      if (error) throw error;
      if (!user){ location.href="login.html"; return null; }

      el("email").value = user.email || "";

      const full = (user.user_metadata?.full_name || "").trim();
      el("subtitle").textContent = full ? ("Meu perfil (comprador) — " + full) : "Meu perfil (comprador)";
      return user;
    }

    async function reloadAll(){
      clearMsg();
      const user = await requireAuth();
      if (!user) return;

      el("first_name").value = metaGet(user, "first_name", "");
      el("last_name").value  = metaGet(user, "last_name", "");
      el("phone").value      = metaGet(user, "phone", "");
      el("address_text").value = metaGet(user, "address_text", "");
    }

    async function saveMeta(payload){
      const { error } = await sb.auth.updateUser({ data: payload });
      if (error) throw error;
    }

    el("form").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      clearMsg();

      const btn = el("saveBtn");
      btn.disabled = true;
      btn.textContent = "Salvando...";

      try{
        const { data:{ user } } = await sb.auth.getUser();
        if (!user) return location.href="login.html";

        const first_name = el("first_name").value.trim().slice(0,30);
        const last_name  = el("last_name").value.trim().slice(0,30);
        const full_name  = (first_name + " " + last_name).trim();

        const phone = el("phone").value.trim();
        const address_text = el("address_text").value.trim();

        if (!first_name) throw new Error("Informe seu nome.");
        if (!last_name) throw new Error("Informe seu sobrenome.");
        if (!phone) throw new Error("Informe seu celular.");

        await saveMeta({
          role: "buyer",
          first_name,
          last_name,
          full_name,
          phone,
          address_text: address_text || null
        });

        // tenta também atualizar no profiles (se existir as colunas)
        try{
          await sb.from("profiles")
            .update({ full_name, address_text: address_text || null })
            .eq("id", user.id);
        }catch(_e){}

        showMsg("Perfil salvo ✅", false);
        await reloadAll();
      }catch(e){
        showMsg(e.message || "Erro ao salvar.", true);
      }finally{
        btn.disabled = false;
        btn.textContent = "Salvar";
      }
    });

    el("reloadBtn").onclick = reloadAll;

    el("back").onclick = ()=> location.href="telainicial-comp.html";
    el("logout").onclick = async ()=>{
      await sb.auth.signOut();
      location.href="login.html";
    };

    (async ()=>{
      try{ await reloadAll(); }
      catch(e){ showMsg(e.message || "Erro ao carregar perfil.", true); }
    })();
  </script>
</body>
</html>
